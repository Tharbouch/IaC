# GitHub Actions Workflow: Drift Detection
# Purpose: Detect configuration drift between Terraform and AWS
# Phase: 4 (Continuous Monitoring)
#
# What this does:
# - Runs on a schedule (daily)
# - Compares Terraform state with actual AWS resources
# - Detects manual changes made outside Terraform
# - Alerts on drift detected

name: Drift Detection

# ==============================================================================
# TRIGGER CONFIGURATION
# ==============================================================================

on:
  # Run on a schedule (every 6 hours)
  schedule:
    - cron: "0 */6 * * *" # every 6 hours

  # Manual trigger
  workflow_dispatch:

  # Run after deployments
  workflow_run:
    workflows: ["Deploy to AWS"]
    types:
      - completed

# ==============================================================================
# PERMISSIONS
# ==============================================================================

permissions:
  contents: read
  issues: write # To create issues for drift alerts

# ==============================================================================
# ENVIRONMENT VARIABLES
# ==============================================================================

env:
  AWS_REGION: "us-east-1"
  TF_VERSION: "1.6.0"

# ==============================================================================
# JOBS
# ==============================================================================

jobs:
  # ============================================================================
  # JOB 1: DRIFTCTL SCAN
  # ============================================================================

  driftctl-scan:
    name: Driftctl Drift Detection
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.driftctl.outputs.drift_detected }}

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Step 3: Setup Terraform (needed for state file)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Step 4: Terraform Init
      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      # Step 5: Install Driftctl
      - name: Install Driftctl
        run: |
          curl -L https://github.com/snyk/driftctl/releases/latest/download/driftctl_linux_amd64 -o driftctl
          chmod +x driftctl
          sudo mv driftctl /usr/local/bin/
          driftctl version

      # Step 6: Run Driftctl scan
      - name: Run Driftctl Scan
        id: driftctl
        run: |
          cd terraform

          echo "Running Driftctl to detect infrastructure drift..."
          driftctl scan \
            --from tfstate+s3://devsecops-thesis-state-1763421190/devsecops/terraform.tfstate \
            --output json://drift-results.json \
            --output console || true

          # Check if drift was detected
          if [ -f drift-results.json ]; then
            unmanaged=$(jq '.summary.total_unmanaged' drift-results.json)
            missing=$(jq '.summary.total_missing' drift-results.json)
            drift=$(jq '.summary.total_managed_drift' drift-results.json)

            echo "unmanaged=$unmanaged" >> $GITHUB_OUTPUT
            echo "missing=$missing" >> $GITHUB_OUTPUT
            echo "drift=$drift" >> $GITHUB_OUTPUT

            total_drift=$((unmanaged + missing + drift))
            echo "total_drift=$total_drift" >> $GITHUB_OUTPUT

            if [ $total_drift -gt 0 ]; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
            fi
          fi

      # Step 7: Generate drift report
      - name: Generate Drift Report
        if: always()
        run: |
          cd terraform

          cat > drift-report.md << 'EOF'
          # Infrastructure Drift Detection Report

          **Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Summary

          | Category | Count |
          |----------|-------|
          | Unmanaged Resources | ${{ steps.driftctl.outputs.unmanaged || 0 }} |
          | Missing Resources | ${{ steps.driftctl.outputs.missing || 0 }} |
          | Drifted Resources | ${{ steps.driftctl.outputs.drift || 0 }} |
          | **Total Drift** | **${{ steps.driftctl.outputs.total_drift || 0 }}** |

          EOF

          if [ "${{ steps.driftctl.outputs.drift_detected }}" == "true" ]; then
            cat >> drift-report.md << 'EOF'

          ## âš ï¸ Drift Detected!

          Infrastructure drift has been detected. This means resources have been modified outside of Terraform.

          **What is drift?**
          - **Unmanaged:** Resources exist in AWS but not in Terraform
          - **Missing:** Resources defined in Terraform but don't exist in AWS
          - **Drifted:** Resources modified manually (not matching Terraform)

          **Recommended Actions:**
          1. Review the drift details below
          2. Determine if changes were intentional
          3. Update Terraform to match AWS, OR
          4. Revert AWS changes to match Terraform

          <details>
          <summary>View Detailed Drift Report</summary>

          \`\`\`json
          EOF

            if [ -f drift-results.json ]; then
              cat drift-results.json >> drift-report.md
            fi

            cat >> drift-report.md << 'EOF'
          \`\`\`

          </details>
          EOF
          else
            cat >> drift-report.md << 'EOF'

          ## âœ… No Drift Detected

          All infrastructure resources match Terraform configuration.
          EOF
          fi

      # Step 8: Display summary
      - name: Display Drift Summary
        run: |
          echo "# ðŸ” Driftctl Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Driftctl has known limitations and may not detect all drift types." >> $GITHUB_STEP_SUMMARY
          echo "> For comprehensive drift detection, check the **'Terraform Drift Check'** job below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat terraform/drift-report.md >> $GITHUB_STEP_SUMMARY

      # Step 9: Upload drift results
      - name: Upload Drift Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drift-detection-results
          path: |
            terraform/drift-results.json
            terraform/drift-report.md

      # Step 10: Create GitHub issue if drift detected
      - name: Create Issue for Drift
        if: steps.driftctl.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('terraform/drift-report.md', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Infrastructure Drift Detected',
              body: report,
              labels: ['drift-detection', 'infrastructure', 'security']
            });

            console.log(`Created issue #${issue.data.number}`);

  # ============================================================================
  # JOB 2: TERRAFORM DRIFT CHECK
  # ============================================================================

  terraform-drift:
    name: Terraform Drift Check
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.plan.outputs.drift_detected }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false # Important: disable wrapper for correct exit codes

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Refresh
        run: |
          cd terraform

          if [ ! -f terraform.tfvars ]; then
            cp terraform.tfvars.example terraform.tfvars
          fi

          terraform refresh

      # FIXED: Correctly capture terraform plan exit code
      - name: Terraform Plan (Detect Changes)
        id: plan
        run: |
          cd terraform

          # Enable pipefail so we capture terraform's exit code, not tee's
          set -o pipefail

          # Run terraform plan with detailed exit code
          # Exit codes: 0 = no changes, 1 = error, 2 = changes detected (drift!)
          terraform plan -detailed-exitcode -no-color 2>&1 | tee plan-drift.txt
          exitcode=$?

          echo "Terraform plan exit code: $exitcode"
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          # Determine drift status based on exit code
          if [ "$exitcode" -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ DRIFT DETECTED - Terraform found differences between code and infrastructure!"
          elif [ "$exitcode" -eq 0 ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "âœ… No drift detected - Infrastructure matches Terraform configuration exactly."
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Terraform plan encountered an error (exit code: $exitcode)"
          fi
        continue-on-error: true

      - name: Report Terraform Drift
        if: always()
        run: |
          echo "# âœ… Terraform Drift Check (Authoritative)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **This is the most reliable drift detection method** - uses native \`terraform plan\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.plan.outputs.drift_detected }}" == "true" ]; then
            echo "## âš ï¸ DRIFT DETECTED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Terraform plan shows differences between code and actual infrastructure:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
            head -100 terraform/plan-drift.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… No Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform configuration exactly." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 3: DRIFT DETECTION SUMMARY
  # ============================================================================

  drift-summary:
    name: Drift Detection Summary
    runs-on: ubuntu-latest
    needs: [driftctl-scan, terraform-drift]
    if: always()

    steps:
      - name: Generate Consolidated Summary
        run: |
          echo "# ðŸ“Š Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow uses two drift detection methods for comparison:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Results Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Method | Status | Reliability | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Terraform Plan** âœ… | ${{ needs.terraform-drift.outputs.drift_detected == 'true' && 'âš ï¸ Drift Detected' || 'âœ… No Drift' }} | **HIGH** - Authoritative | Check 'Terraform Drift Check' job |" >> $GITHUB_STEP_SUMMARY
          echo "| Driftctl | ${{ needs.driftctl-scan.outputs.drift_detected == 'true' && 'âš ï¸ Drift Detected' || 'âœ… No Drift' }} | MEDIUM - Has limitations | Check 'Driftctl Drift Detection' job |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸŽ¯ Recommendation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Always trust the Terraform Drift Check results** as it uses native \`terraform plan\`" >> $GITHUB_STEP_SUMMARY
          echo "and detects all types of drift including tag changes and resource modifications." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.terraform-drift.outputs.drift_detected }}" == "true" ]; then
            echo "### âš ï¸ ACTION REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Drift has been detected by Terraform. Review the 'Terraform Drift Check' job for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Clear" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No drift detected. Infrastructure matches Terraform configuration." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 4: COMPLIANCE SCAN
  # ============================================================================

  compliance-scan:
    name: Runtime Compliance Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov on AWS Account
        run: |
          echo "Running compliance scan on deployed AWS resources..."

          # Scan live AWS resources (not just code)
          checkov --framework aws \
            --output cli \
            --output json \
            --output-file-path . \
            --soft-fail || true

      - name: Upload Compliance Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-scan-results
          path: results_json.json
