# GitHub Actions Workflow: Drift Detection
# Purpose: Detect configuration drift between Terraform and AWS
# Phase: 4 (Continuous Monitoring)
#
# What this does:
# - Runs on a schedule (every 6 hours)
# - Compares Terraform state with actual AWS resources
# - Detects manual changes made outside Terraform
# - Alerts on drift detected

name: Drift Detection

# ==============================================================================
# TRIGGER CONFIGURATION
# ==============================================================================

on:
  # Run on a schedule (every 6 hours)
  schedule:
    - cron: "0 */6 * * *" # every 6 hours

  # Manual trigger
  workflow_dispatch:

  # Run after deployments
  workflow_run:
    workflows: ["Deploy to AWS"]
    types:
      - completed

# ==============================================================================
# PERMISSIONS
# ==============================================================================

permissions:
  contents: read
  issues: write # To create issues for drift alerts

# ==============================================================================
# ENVIRONMENT VARIABLES
# ==============================================================================

env:
  AWS_REGION: "us-east-1"
  TF_VERSION: "1.6.0"

jobs:
  # ============================================================================
  # JOB 1: DRIFTCTL SCAN
  # ============================================================================
  driftctl-scan:
    name: Driftctl Drift Detection
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.driftctl.outputs.drift_detected }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Install Driftctl
        run: |
          curl -L https://github.com/snyk/driftctl/releases/latest/download/driftctl_linux_amd64 -o driftctl
          chmod +x driftctl
          sudo mv driftctl /usr/local/bin/
          driftctl version

      - name: Run Driftctl Scan
        id: driftctl
        run: |
          cd terraform

          echo "Running Driftctl to detect infrastructure drift..."
          driftctl scan \
            --from tfstate+s3://devsecops-thesis-state-1763421190/devsecops/terraform.tfstate \
            --output json://drift-results.json \
            --output console || true

          if [ -f drift-results.json ]; then
            unmanaged=$(jq '.summary.total_unmanaged' drift-results.json)
            missing=$(jq '.summary.total_missing' drift-results.json)
            drift=$(jq '.summary.total_managed_drift' drift-results.json)

            echo "unmanaged=$unmanaged" >> $GITHUB_OUTPUT
            echo "missing=$missing" >> $GITHUB_OUTPUT
            echo "drift=$drift" >> $GITHUB_OUTPUT

            total_drift=$((unmanaged + missing + drift))
            echo "total_drift=$total_drift" >> $GITHUB_OUTPUT

            if [ $total_drift -gt 0 ]; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
            else
              echo "drift_detected=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate Drift Report
        if: always()
        run: |
          cd terraform

          # Get current date properly
          SCAN_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          cat > drift-report.md << EOF
          # Infrastructure Drift Detection Report

          **Scan Date:** ${SCAN_DATE}

          ## Summary

          | Category | Count |
          |----------|-------|
          | Unmanaged Resources | ${{ steps.driftctl.outputs.unmanaged || 0 }} |
          | Missing Resources | ${{ steps.driftctl.outputs.missing || 0 }} |
          | Drifted Resources | ${{ steps.driftctl.outputs.drift || 0 }} |
          | **Total Drift** | **${{ steps.driftctl.outputs.total_drift || 0 }}** |

          EOF

          if [ "${{ steps.driftctl.outputs.drift_detected }}" == "true" ]; then
            cat >> drift-report.md << 'EOF'

          ## âš ï¸ Drift Detected!

          Infrastructure drift has been detected.

          **Recommended Actions:**
          1. Review the drift details
          2. Update Terraform to match AWS, OR
          3. Revert AWS changes to match Terraform
          EOF
          else
            cat >> drift-report.md << 'EOF'

          ## âœ… No Drift Detected

          All infrastructure resources match Terraform configuration.
          EOF
          fi

      # Step 8: Display summary
      - name: Display Drift Summary
        run: |
          cat terraform/drift-report.md >> $GITHUB_STEP_SUMMARY

      # Step 9: Upload drift results
      - name: Upload Drift Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drift-detection-results
          path: |
            terraform/drift-results.json
            terraform/drift-report.md

      # Step 10: Create GitHub issue if drift detected
      - name: Create Issue for Drift
        if: steps.driftctl.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('terraform/drift-report.md', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Infrastructure Drift Detected',
              body: report,
              labels: ['drift-detection', 'infrastructure', 'security']
            });

            console.log(`Created issue #${issue.data.number}`);

  # ============================================================================
  # JOB 2: TERRAFORM DRIFT CHECK
  # ============================================================================

  terraform-drift:
    name: Terraform Drift Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Refresh
        run: |
          cd terraform
          if [ ! -f terraform.tfvars ]; then
            cp terraform.tfvars.example terraform.tfvars
          fi
          terraform refresh

      # FIXED v2: More robust exit code capture
      - name: Terraform Plan (Detect Changes)
        id: check-drift
        run: |
          cd terraform

          echo "=========================================="
          echo "Running Terraform Plan with -detailed-exitcode"
          echo "Exit codes: 0=no changes, 1=error, 2=drift detected"
          echo "=========================================="

          # Run terraform plan and capture exit code directly (no pipe!)
          terraform plan -detailed-exitcode -no-color -out=tfplan > plan-drift.txt 2>&1 || exitcode=$?

          # If exitcode wasn't set by || (meaning terraform succeeded with 0), set it
          exitcode=${exitcode:-0}

          echo ""
          echo "=========================================="
          echo "TERRAFORM PLAN EXIT CODE: $exitcode"
          echo "=========================================="

          # Show the plan output
          cat plan-drift.txt

          # Set outputs
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          if [ "$exitcode" -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸš¨ðŸš¨ðŸš¨ DRIFT DETECTED! ðŸš¨ðŸš¨ðŸš¨"
            echo "Terraform found differences between code and infrastructure!"
          elif [ "$exitcode" -eq 0 ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ… No drift detected - Infrastructure matches code exactly."
          else
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ Terraform plan encountered an error (exit code: $exitcode)"
          fi

      - name: Debug Outputs
        if: always()
        run: |
          echo "=========================================="
          echo "DEBUG: Checking step outputs"
          echo "=========================================="
          echo "drift_detected = ${{ steps.check-drift.outputs.drift_detected }}"
          echo "exitcode = ${{ steps.check-drift.outputs.exitcode }}"
          echo "=========================================="

      - name: Report Terraform Drift
        if: always()
        run: |
          DRIFT_STATUS="${{ steps.check-drift.outputs.drift_detected }}"
          EXIT_CODE="${{ steps.check-drift.outputs.exitcode }}"

          echo "# âœ… Terraform Drift Check (Authoritative)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **This is the most reliable drift detection method** - uses native \`terraform plan\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Exit Code:** ${EXIT_CODE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRIFT_STATUS" == "true" ]; then
            echo "## âš ï¸ DRIFT DETECTED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Terraform plan shows differences between code and actual infrastructure." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View Plan Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
            cat terraform/plan-drift.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          elif [ "$DRIFT_STATUS" == "error" ]; then
            echo "## âš ï¸ Error During Plan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Terraform plan encountered an error. Check logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… No Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform configuration exactly." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 3: DRIFT DETECTION SUMMARY
  # ============================================================================
  drift-summary:
    name: Drift Detection Summary
    runs-on: ubuntu-latest
    needs: [driftctl-scan, terraform-drift]
    if: always()

    steps:
      - name: Generate Consolidated Summary
        run: |
          TF_DRIFT="${{ needs.terraform-drift.outputs.drift_detected }}"
          TF_EXIT="${{ needs.terraform-drift.outputs.exitcode }}"
          DC_DRIFT="${{ needs.driftctl-scan.outputs.drift_detected }}"

          echo "# ðŸ“Š Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Debug Info" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform drift_detected: \`${TF_DRIFT}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform exit code: \`${TF_EXIT}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Driftctl drift_detected: \`${DC_DRIFT}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Results Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Method | Status | Reliability | Exit Code |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------------|-----------|" >> $GITHUB_STEP_SUMMARY

          if [ "$TF_DRIFT" == "true" ]; then
            echo "| **Terraform Plan** | âš ï¸ **DRIFT DETECTED** | HIGH | ${TF_EXIT} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Terraform Plan** | âœ… No Drift | HIGH | ${TF_EXIT} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DC_DRIFT" == "true" ]; then
            echo "| Driftctl | âš ï¸ Drift Detected | MEDIUM | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Driftctl | âœ… No Drift | MEDIUM | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TF_DRIFT" == "true" ]; then
            echo "### âš ï¸ ACTION REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Drift has been detected!** Review the 'Terraform Drift Check' job for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Clear" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No drift detected. Infrastructure matches Terraform configuration." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 4: COMPLIANCE SCAN
  # ============================================================================
  compliance-scan:
    name: Runtime Compliance Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov on AWS Account
        run: |
          echo "Running compliance scan on deployed AWS resources..."
          checkov --framework aws \
            --output cli \
            --output json \
            --output-file-path . \
            --soft-fail || true

      - name: Upload Compliance Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-scan-results
          path: results_json.json

# ==============================================================================
# TESTING INSTRUCTIONS (For Thesis)
# ==============================================================================

# TEST SCENARIO: Create Intentional Drift
#
# 1. Deploy infrastructure using Terraform
#
# 2. Manually modify a resource in AWS Console:
#    Option A: Modify S3 bucket
#      - Go to S3 in AWS Console
#      - Find your bucket (devsecops-thesis-...)
#      - Disable versioning OR
#      - Add a tag OR
#      - Modify encryption settings
#
#    Option B: Modify EC2 instance
#      - Go to EC2 in AWS Console
#      - Find your instance
#      - Add/remove tags OR
#      - Modify security group
#
# 3. Trigger drift detection workflow:
#    - Go to Actions tab
#    - Select "Drift Detection"
#    - Click "Run workflow"
#
# 4. Expected results:
#    - Driftctl detects the modification
#    - Terraform plan shows changes
#    - GitHub issue created
#    - Drift report generated
#
# 5. Screenshots for thesis:
#    ðŸ“¸ AWS Console showing manual change
#    ðŸ“¸ Drift detection workflow results
#    ðŸ“¸ Drift report with differences
#    ðŸ“¸ GitHub issue created
#
# 6. Remediation options:
#    Option A: Update Terraform to match AWS
#      - Modify terraform code
#      - Run terraform plan
#      - Apply changes
#
#    Option B: Revert AWS to match Terraform
#      - Run terraform apply
#      - Terraform will revert manual changes

# ==============================================================================
# DRIFT DETECTION STRATEGIES
# ==============================================================================

# STRATEGY 1: Driftctl (Comprehensive)
# - Detects all resource types
# - Shows unmanaged resources
# - Detailed JSON output
# - Best for: Complete drift analysis
#
# STRATEGY 2: Terraform Plan (Simple)
# - Uses native Terraform
# - Shows exact changes
# - Easy to understand
# - Best for: Quick drift check
#
# STRATEGY 3: AWS Config (Cloud-Native)
# - AWS-native service
# - Continuous monitoring
# - Compliance rules
# - Best for: Production environments
#
# For thesis: Compare all three approaches!

# ==============================================================================
# METRICS TO COLLECT
# ==============================================================================

# For your thesis analysis:
# - Drift detection time
# - Types of drift detected
# - False positive rate
# - Mean time to detect drift
# - Mean time to remediate drift
# - Comparison: Driftctl vs Terraform plan

# ==============================================================================
# CUSTOMIZATION
# ==============================================================================

# To change scan frequency:
# - Modify cron schedule (line 17)
# - Options:
#   - '0 */6 * * *'  # Every 6 hours
#   - '0 0 * * *'    # Daily at midnight
#   - '0 9 * * 1'    # Weekly on Monday at 9 AM
#
# To add notifications:
# - Add Slack/email notification steps
# - Integrate with monitoring tools
#
# To exclude resources from drift detection:
# - Use driftctl --driftignore flag
# - Create .driftignore file
