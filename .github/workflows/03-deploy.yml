# GitHub Actions Workflow: Secure Deployment
# Purpose: Deploy infrastructure to AWS with manual approval
# Phase: 3 (Secure Deployment)
#
# What this does:
# - Generates Terraform plan on merge to main
# - Requires manual approval before deployment
# - Applies infrastructure changes to AWS
# - Provides deployment summary

name: Deploy to AWS

# ==============================================================================
# TRIGGER CONFIGURATION
# ==============================================================================

on:
  # Trigger on push to main (after PR merge)
  push:
    branches:
      - main
    paths:
      - 'terraform/**'

  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

# ==============================================================================
# ENVIRONMENT VARIABLES
# ==============================================================================

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

# ==============================================================================
# PERMISSIONS
# ==============================================================================

permissions:
  contents: read
  pull-requests: write
  id-token: write  # For OIDC authentication (more secure than keys)

# ==============================================================================
# JOBS
# ==============================================================================

jobs:
  # ============================================================================
  # JOB 1: TERRAFORM PLAN
  # ============================================================================

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    environment: production  # Requires approval for production

    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Step 3: Configure AWS credentials
      # IMPORTANT: Set up AWS credentials in GitHub Secrets
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Step 4: Terraform Init
      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      # Step 5: Terraform Validate
      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      # Step 6: Terraform Plan
      - name: Terraform Plan
        id: plan
        run: |
          cd terraform

          # Create tfvars if doesn't exist
          if [ ! -f terraform.tfvars ]; then
            cp terraform.tfvars.example terraform.tfvars
          fi

          # Generate plan
          terraform plan \
            -out=tfplan \
            -detailed-exitcode \
            -no-color \
            | tee plan-output.txt

          # Capture exit code
          exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          # Exit codes:
          # 0 = No changes
          # 1 = Error
          # 2 = Changes present

          if [ $exitcode -eq 1 ]; then
            echo "âŒ Terraform plan failed"
            exit 1
          fi
        continue-on-error: true

      # Step 7: Display plan summary
      - name: Display Plan Summary
        run: |
          cd terraform

          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.plan.outputs.exitcode }}" -eq 0 ]; then
            echo "â„¹ï¸ **No infrastructure changes detected**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" -eq 2 ]; then
            echo "ðŸ“ **Infrastructure changes detected:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -A 50 "Terraform will perform" plan-output.txt | head -50 >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # Step 8: Upload plan artifact
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        if: steps.plan.outputs.exitcode == '2'
        with:
          name: terraform-plan
          path: |
            terraform/tfplan
            terraform/plan-output.txt

  # ============================================================================
  # JOB 2: MANUAL APPROVAL (Production Environment)
  # ============================================================================

  approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.plan_exitcode == '2'
    environment:
      name: production
      # GitHub will pause here and wait for approval

    steps:
      - name: Approval Granted
        run: |
          echo "âœ… Deployment approved!"
          echo "Proceeding with terraform apply..."

  # ============================================================================
  # JOB 3: TERRAFORM APPLY
  # ============================================================================

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, approval]
    if: needs.terraform-plan.outputs.plan_exitcode == '2'

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Step 3: Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Step 4: Download plan artifact
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/

      # Step 5: Terraform Init
      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      # Step 6: Terraform Apply
      - name: Terraform Apply
        id: apply
        run: |
          cd terraform
          terraform apply -auto-approve tfplan | tee apply-output.txt

          echo "âœ… Infrastructure deployed successfully!"

      # Step 7: Capture outputs
      - name: Get Terraform Outputs
        id: outputs
        run: |
          cd terraform

          echo "## Deployment Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # Step 8: Verify deployment
      - name: Verify AWS Resources
        run: |
          echo "Verifying deployed resources..."

          # List EC2 instances
          echo "EC2 Instances:"
          aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=DevSecOps-Thesis" \
            --query 'Reservations[].Instances[].[InstanceId,State.Name,PublicIpAddress]' \
            --output table

          # List S3 buckets
          echo "S3 Buckets:"
          aws s3 ls | grep devsecops

      # Step 9: Upload apply logs
      - name: Upload Apply Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-apply-logs
          path: terraform/apply-output.txt

  # ============================================================================
  # JOB 4: POST-DEPLOYMENT VALIDATION
  # ============================================================================

  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: terraform-apply

    steps:
      - name: Run Security Scan on Deployed Infrastructure
        run: |
          echo "ðŸ“Š Post-deployment security validation"
          echo "In a production environment, this would:"
          echo "  - Run runtime security scans"
          echo "  - Verify security group rules"
          echo "  - Check encryption status"
          echo "  - Validate IAM policies"

      - name: Deployment Success Notification
        run: |
          echo "## âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure has been deployed to AWS." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify resources in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Test application functionality" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor for drift (Phase 4)" >> $GITHUB_STEP_SUMMARY
          echo "4. Remember to destroy resources after testing!" >> $GITHUB_STEP_SUMMARY

# ==============================================================================
# SEPARATE WORKFLOW: DESTROY INFRASTRUCTURE
# ==============================================================================

  terraform-destroy:
    name: Terraform Destroy (Manual Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment: production  # Requires approval

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Destroy
        run: |
          cd terraform

          if [ ! -f terraform.tfvars ]; then
            cp terraform.tfvars.example terraform.tfvars
          fi

          terraform destroy -auto-approve

      - name: Verify Destruction
        run: |
          echo "Verifying resources are destroyed..."

          # Check EC2 instances
          instances=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=DevSecOps-Thesis" \
            --query 'Reservations[].Instances[?State.Name!=`terminated`].InstanceId' \
            --output text)

          if [ -z "$instances" ]; then
            echo "âœ… All EC2 instances terminated"
          else
            echo "âš ï¸ Warning: Some instances still exist: $instances"
          fi

          echo "## âœ… Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "All resources have been removed from AWS." >> $GITHUB_STEP_SUMMARY

# ==============================================================================
# SETUP INSTRUCTIONS (For Students)
# ==============================================================================

# BEFORE USING THIS WORKFLOW:
#
# 1. Create GitHub Environment:
#    - Go to Settings > Environments
#    - Create "production" environment
#    - Add required reviewers (yourself)
#
# 2. Add AWS Credentials to GitHub Secrets:
#    - Go to Settings > Secrets > Actions
#    - Add: AWS_ACCESS_KEY_ID
#    - Add: AWS_SECRET_ACCESS_KEY
#
# 3. Test workflow:
#    - Make a change to terraform/
#    - Commit and push to main
#    - Workflow triggers automatically
#    - Review and approve deployment
#
# 4. Manual destroy:
#    - Actions tab > Deploy to AWS
#    - Run workflow
#    - Select "destroy" action
#    - Approve destruction

# ==============================================================================
# THESIS DOCUMENTATION POINTS
# ==============================================================================

# ðŸ“¸ SCREENSHOT 1: Terraform Plan Output
# - Show the plan step with resource changes
#
# ðŸ“¸ SCREENSHOT 2: Manual Approval Interface
# - Show GitHub waiting for approval
# - Show approval being granted
#
# ðŸ“¸ SCREENSHOT 3: Successful Deployment
# - Show green checkmarks for all jobs
# - Show deployment outputs
#
# ðŸ“¸ SCREENSHOT 4: AWS Console
# - Show deployed EC2 instance
# - Show created S3 bucket
# - Show VPC and networking
#
# ðŸ“Š METRICS TO COLLECT:
# - Time from commit to plan generation
# - Time waiting for approval
# - Time for apply to complete
# - Total deployment duration

# ==============================================================================
# SECURITY BEST PRACTICES
# ==============================================================================

# âœ… Manual approval required (prevents accidental deployment)
# âœ… AWS credentials stored as secrets (not in code)
# âœ… Plan reviewed before apply
# âœ… Post-deployment validation
# âœ… Separate destroy workflow (prevents accidental deletion)
# âœ… Audit trail (all deployments logged in GitHub Actions)
