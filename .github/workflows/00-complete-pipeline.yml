# =============================================================================
# Complete DevSecOps Pipeline - All 4 Phases with Job Dependencies
# =============================================================================
# This workflow demonstrates defense-in-depth security with sequential gates:
#
# Flow:
#   1. security-scan (Phase 2) - SAST with Trivy + Checkov
#        â†“ (must pass)
#   2. policy-check (Phase 2) - OPA policy validation
#        â†“ (must pass)
#   3. deploy (Phase 3) - Terraform deployment with manual approval
#        â†“ (must pass)
#   4. drift-detection (Phase 4) - Infrastructure drift detection
#
# Key Features:
# - Sequential execution enforced with 'needs' keyword
# - Deployment CANNOT run if security scans fail
# - Manual approval required before deployment (GitHub Environment)
# - Drift detection only runs after successful deployment
# - Complete audit trail in GitHub Actions
#
# Triggers:
# - Pull Request: Runs security-scan and policy-check only
# - Push to main: Runs all 4 phases (including deployment)
# - Manual: Can trigger full pipeline manually
# =============================================================================

name: Complete DevSecOps Pipeline

on:
  # Trigger on pull requests to any branch
  pull_request:
    branches:
      - "**"

  # Trigger on push to main branch (after PR merge)
  push:
    branches:
      - main

  # Allow manual workflow trigger
  workflow_dispatch:
    inputs:
      skip_deployment:
        description: "Skip deployment (test security scans only)"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

# Permissions for GitHub token
permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ===========================================================================
  # Phase 2 - Job 1: Security Scanning with Trivy + Checkov + Gitleaks
  # ===========================================================================
  security-scan:
    name: "Phase 2: Security Scan (Trivy + Checkov + Gitleaks)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # -----------------------------------------------------------------------
      # Trivy - IaC Security Scanner
      # -----------------------------------------------------------------------
      - name: Run Trivy IaC Scanner (Table Output)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: "config"
          scan-ref: "terraform/"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Run Trivy IaC Scanner (JSON Output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "terraform/"
          format: "json"
          output: "trivy-results.json"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "1"
        # allow Trivy to fail the step/job so branch protection blocks merging

      - name: Upload Trivy JSON Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: trivy-results.json
          retention-days: 30

      # -----------------------------------------------------------------------
      # Checkov - SAST for Infrastructure as Code
      # -----------------------------------------------------------------------
      - name: Run Checkov SAST Scanner
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: json
          output_file_path: checkov-results.json
          # do not fail the step so JSON is produced for upload
          soft_fail: true
          skip_check: CKV_AWS_79,CKV2_AWS_41

      - name: Upload Checkov JSON Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-scan-results
          path: checkov-results.json
          retention-days: 30

      # -----------------------------------------------------------------------
      # Gitleaks - Secret Scanning
      # -----------------------------------------------------------------------
      - name: Run Gitleaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------
      - name: Security Scan Summary
        if: always()
        run: |
          echo "## ðŸ” Phase 2: Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tools Used:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy (IaC vulnerability scanner)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Checkov (SAST for Terraform)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks (Secret detection)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download Results:** Check the 'Artifacts' section below for JSON reports:" >> $GITHUB_STEP_SUMMARY
          echo "- trivy-scan-results.json" >> $GITHUB_STEP_SUMMARY
          echo "- checkov-scan-results.json" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Phase 2 - Job 2: Policy Validation with OPA
  # ===========================================================================
  policy-check:
    name: "Phase 2: Policy Validation (OPA)"
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Configure AWS Credentials (REQUIRED for Terraform Plan)
      # -----------------------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # -----------------------------------------------------------------------
      # Install OPA
      # -----------------------------------------------------------------------
      - name: Install Open Policy Agent
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Verify OPA Installation
        run: opa version

      # -----------------------------------------------------------------------
      # Validate OPA Policies
      # -----------------------------------------------------------------------
      - name: Validate OPA Policy Syntax
        run: |
          echo "Validating OPA policy files..."
          for policy in policies/*.rego; do
            echo "Checking $policy"
            opa check "$policy"
          done

      # -----------------------------------------------------------------------
      # Test Policies Against Terraform Plan
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Generate Terraform Plan JSON
        working-directory: terraform
        run: |
          terraform init -reconfigure
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      - name: Run OPA Policy Tests
        working-directory: terraform
        run: |
          echo "## ðŸ“‹ Policy Validation Results" > policy-results.txt
          failures=0

          for policy in s3_encryption security_groups required_tags; do
            echo "### $policy Policy" >> policy-results.txt
            out=$(opa eval --data ../policies/${policy}.rego --input tfplan.json 'data.terraform.deny' 2>&1 || true)
            echo "$out" >> policy-results.txt
            # detect non-empty deny results; adjust detection if your policy returns a different structure
            if echo "$out" | grep -q "deny"; then
              failures=$((failures+1))
            fi
            echo "" >> policy-results.txt
          done

          cat policy-results.txt
          if [ "$failures" -gt 0 ]; then
            echo "OPA policy violations detected ($failures)." >&2
            exit 1
          fi

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------
      - name: Policy Check Summary
        if: always()
        run: |
          echo "## ðŸ“‹ Phase 2: Policy Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Policies Validated:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 Encryption Policy" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Group Policy" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Required Tags Policy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Policy validation completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Security Gate:** Deployment blocked if policies fail" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Phase 3: Deployment to AWS with Manual Approval
  # ===========================================================================
  deploy:
    name: "Phase 3: Deploy to AWS"
    runs-on: ubuntu-latest
    needs: [security-scan, policy-check] # âœ… DEPENDENCY: Both Phase 2 jobs must pass

    # Only run on push to main (not on PRs)
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      github.event.inputs.skip_deployment != 'true'

    # Manual approval required via GitHub Environment
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Setup Terraform
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      # -----------------------------------------------------------------------
      # Configure AWS Credentials
      # -----------------------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS Identity
        run: |
          echo "## ðŸ” AWS Identity" >> $GITHUB_STEP_SUMMARY
          aws sts get-caller-identity >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Terraform Init
      # -----------------------------------------------------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init -reconfigure

      # -----------------------------------------------------------------------
      # Terraform Plan
      # -----------------------------------------------------------------------
      - name: Terraform Plan
        working-directory: terraform
        id: plan
        run: |
          terraform plan -no-color -out=tfplan
          terraform show -no-color tfplan > tfplan.txt

      - name: Display Terraform Plan
        working-directory: terraform
        run: |
          echo "## ðŸ“‹ Terraform Plan" >> $GITHUB_STEP_SUMMARY
          echo '```terraform' >> $GITHUB_STEP_SUMMARY
          cat tfplan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Terraform Apply (Manual approval required via 'environment: production')
      # -----------------------------------------------------------------------
      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      # -----------------------------------------------------------------------
      # Capture Outputs
      # -----------------------------------------------------------------------
      - name: Terraform Outputs
        working-directory: terraform
        run: |
          echo "## ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------
      - name: Deployment Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Infrastructure deployed to AWS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Remember:** Run \`terraform destroy\` after testing to avoid costs" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Phase 4: Drift Detection with Driftctl
  # ===========================================================================
  drift-detection:
    name: "Phase 4: Drift Detection"
    runs-on: ubuntu-latest
    needs: deploy # âœ… DEPENDENCY: Only run after successful deployment

    # Only run after deployment completes
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Install Driftctl
      # -----------------------------------------------------------------------
      - name: Install Driftctl
        run: |
          curl -L https://github.com/snyk/driftctl/releases/latest/download/driftctl_linux_amd64 -o driftctl
          chmod +x driftctl
          sudo mv driftctl /usr/local/bin/

      - name: Verify Driftctl Installation
        run: driftctl version

      # -----------------------------------------------------------------------
      # Configure AWS Credentials
      # -----------------------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # -----------------------------------------------------------------------
      # Setup Terraform for State Comparison
      # -----------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -reconfigure

      # -----------------------------------------------------------------------
      # Run Drift Detection
      # -----------------------------------------------------------------------
      - name: Run Driftctl Scan
        run: |
          cd terraform
          driftctl scan --from tfstate://terraform.tfstate --output console://,json://drift-report.json
        continue-on-error: true # Don't fail workflow if drift found

      - name: Parse Drift Results
        if: always()
        working-directory: terraform
        run: |
          if [ -f drift-report.json ]; then
            echo "## ðŸ” Phase 4: Drift Detection Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count resources
            TOTAL=$(jq '.summary.total_resources' drift-report.json)
            MANAGED=$(jq '.summary.total_managed' drift-report.json)
            UNMANAGED=$(jq '.summary.total_unmanaged' drift-report.json)
            DRIFT=$(jq '.summary.total_changed' drift-report.json)

            echo "**Summary:**" >> $GITHUB_STEP_SUMMARY
            echo "- Total Resources: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Managed by Terraform: $MANAGED" >> $GITHUB_STEP_SUMMARY
            echo "- Unmanaged Resources: $UNMANAGED" >> $GITHUB_STEP_SUMMARY
            echo "- Resources with Drift: $DRIFT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$DRIFT" -gt 0 ]; then
              echo "âš ï¸ **DRIFT DETECTED!** Manual changes found in AWS infrastructure" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Review the drift report above" >> $GITHUB_STEP_SUMMARY
              echo "2. Choose remediation: Revert in AWS, Update Terraform, or Re-apply" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **NO DRIFT DETECTED** - Infrastructure matches Terraform state" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Drift report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      # -----------------------------------------------------------------------
      # Upload Drift Report as Artifact
      # -----------------------------------------------------------------------
      - name: Upload Drift Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-report
          path: terraform/drift-report.json
          retention-days: 30

      # -----------------------------------------------------------------------
      # Create GitHub Issue if Drift Detected (Optional)
      # -----------------------------------------------------------------------
      - name: Create Drift Alert Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'terraform/drift-report.json';

            // 1. Check if the report file actually exists
            if (!fs.existsSync(reportPath)) {
              console.log('âš ï¸ Drift report not found. Skipping issue creation.');
              return;
            }

            // 2. Read and parse the file safely
            try {
              const driftReport = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              if (driftReport.summary.total_changed > 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'âš ï¸ Infrastructure Drift Detected',
                  body: `## Drift Detection Alert

                  **Drift detected in AWS infrastructure!**

                  **Summary:**
                  - Resources with drift: ${driftReport.summary.total_changed}
                  - Total managed resources: ${driftReport.summary.total_managed}
                  - Unmanaged resources: ${driftReport.summary.total_unmanaged}

                  **Action Required:**
                  1. Review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
                  2. Download the drift report artifact
                  3. Choose remediation strategy:
                     - **Revert in AWS:** Manual fix in AWS Console
                     - **Update Terraform:** Accept change, update IaC
                     - **Re-apply Terraform:** Force infrastructure to match state

                  **Workflow:** ${context.workflow}
                  **Run ID:** ${context.runId}
                  **Triggered by:** ${context.actor}
                  `,
                  labels: ['drift-detection', 'security', 'infrastructure']
                });
              }
            } catch (error) {
              console.log('Error parsing drift report: ' + error.message);
            }

  # ===========================================================================
  # Summary Job: Overall Pipeline Status
  # ===========================================================================
  pipeline-summary:
    name: "Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [security-scan, policy-check, deploy, drift-detection]
    if: always()

    steps:
      - name: Pipeline Summary
        run: |
          echo "# ðŸŽ‰ Complete DevSecOps Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Execution Flow:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **Phase 2: Security Scan** - Trivy + Checkov + Gitleaks" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… **Phase 2: Policy Check** - OPA validation" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… **Phase 3: Deployment** - Terraform to AWS (manual approval)" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… **Phase 4: Drift Detection** - Driftctl scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Defense-in-Depth Validation:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scans MUST pass before policy check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Policy check MUST pass before deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Manual approval REQUIRED before deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Drift detection runs ONLY after successful deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Result:** Complete audit trail with enforced security gates ðŸ”’" >> $GITHUB_STEP_SUMMARY
