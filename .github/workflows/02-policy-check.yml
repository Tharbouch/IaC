# GitHub Actions Workflow: OPA Policy Validation
# Purpose: Enforce custom policies using Open Policy Agent
# Phase: 2 (CI Security Gate)
#
# What this does:
# - Validates Terraform against custom OPA policies
# - Enforces organizational standards (tags, naming, etc.)
# - Blocks PR if policy violations found

name: OPA Policy Check

# ==============================================================================
# TRIGGER CONFIGURATION
# ==============================================================================

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'terraform/**'
      - 'policies/**'
      - '.github/workflows/02-policy-check.yml'

  workflow_dispatch:

# ==============================================================================
# PERMISSIONS
# ==============================================================================

permissions:
  contents: read
  pull-requests: write

# ==============================================================================
# JOBS
# ==============================================================================

jobs:
  opa-policy-check:
    name: OPA Policy Validation
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      # Step 3: Initialize Terraform
      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      # Step 4: Generate Terraform plan
      - name: Generate Terraform Plan
        id: plan
        run: |
          cd terraform
          # Create example tfvars if doesn't exist
          if [ ! -f terraform.tfvars ]; then
            cp terraform.tfvars.example terraform.tfvars
          fi

          # Generate plan
          terraform plan -out=tfplan.binary

          # Convert to JSON
          terraform show -json tfplan.binary > tfplan.json
        continue-on-error: true

      # Step 5: Install OPA
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/
          opa version

      # Step 6: Test OPA policies syntax
      - name: Test OPA Policy Syntax
        run: |
          echo "Testing OPA policy syntax..."
          opa test policies/ -v

      # Step 7: Run S3 Encryption Policy
      - name: Check S3 Encryption Policy
        id: s3-policy
        run: |
          echo "Checking S3 encryption policy..."
          cd terraform

          violations=$(opa eval \
            -i tfplan.json \
            -d ../policies/s3_encryption.rego \
            "data.terraform.s3_encryption.deny" \
            --format pretty)

          echo "$violations"

          if echo "$violations" | grep -q "\[\]"; then
            echo "✅ S3 encryption policy: PASS"
            echo "s3_policy_result=pass" >> $GITHUB_OUTPUT
          else
            echo "❌ S3 encryption policy: FAIL"
            echo "s3_policy_result=fail" >> $GITHUB_OUTPUT
            echo "violations<<EOF" >> $GITHUB_OUTPUT
            echo "$violations" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Step 8: Run Security Groups Policy
      - name: Check Security Groups Policy
        id: sg-policy
        run: |
          echo "Checking security groups policy..."
          cd terraform

          violations=$(opa eval \
            -i tfplan.json \
            -d ../policies/security_groups.rego \
            "data.terraform.security_groups.deny" \
            --format pretty)

          echo "$violations"

          if echo "$violations" | grep -q "\[\]"; then
            echo "✅ Security groups policy: PASS"
            echo "sg_policy_result=pass" >> $GITHUB_OUTPUT
          else
            echo "❌ Security groups policy: FAIL"
            echo "sg_policy_result=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Step 9: Run Required Tags Policy
      - name: Check Required Tags Policy
        id: tags-policy
        run: |
          echo "Checking required tags policy..."
          cd terraform

          violations=$(opa eval \
            -i tfplan.json \
            -d ../policies/required_tags.rego \
            "data.terraform.required_tags.deny" \
            --format pretty)

          echo "$violations"

          if echo "$violations" | grep -q "\[\]"; then
            echo "✅ Required tags policy: PASS"
            echo "tags_policy_result=pass" >> $GITHUB_OUTPUT
          else
            echo "❌ Required tags policy: FAIL"
            echo "tags_policy_result=fail" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Step 10: Generate policy report
      - name: Generate Policy Report
        run: |
          cat > policy-report.md << 'EOF'
          # OPA Policy Check Report

          ## Policy Results

          | Policy | Result |
          |--------|--------|
          | S3 Encryption | ${{ steps.s3-policy.outputs.s3_policy_result == 'pass' && '✅ PASS' || '❌ FAIL' }} |
          | Security Groups | ${{ steps.sg-policy.outputs.sg_policy_result == 'pass' && '✅ PASS' || '❌ FAIL' }} |
          | Required Tags | ${{ steps.tags-policy.outputs.tags_policy_result == 'pass' && '✅ PASS' || '❌ FAIL' }} |

          ## Summary

          EOF

          if [ "${{ steps.s3-policy.outputs.s3_policy_result }}" == "pass" ] && \
             [ "${{ steps.sg-policy.outputs.sg_policy_result }}" == "pass" ] && \
             [ "${{ steps.tags-policy.outputs.tags_policy_result }}" == "pass" ]; then
            echo "✅ **All policies passed!** Infrastructure complies with organizational standards." >> policy-report.md
          else
            echo "❌ **Policy violations detected!** Please review and fix before merging." >> policy-report.md
          fi

      # Step 11: Comment on PR
      - name: Comment Policy Results on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('policy-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      # Step 12: Upload artifacts
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-plan
          path: terraform/tfplan.json

      - name: Upload Policy Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: policy-report
          path: policy-report.md

      # Step 13: Fail if any policy failed
      - name: Check Overall Policy Status
        run: |
          if [ "${{ steps.s3-policy.outputs.s3_policy_result }}" == "fail" ] || \
             [ "${{ steps.sg-policy.outputs.sg_policy_result }}" == "fail" ] || \
             [ "${{ steps.tags-policy.outputs.tags_policy_result }}" == "fail" ]; then
            echo "❌ One or more policies failed"
            echo ""
            echo "Policy Results:"
            echo "  S3 Encryption: ${{ steps.s3-policy.outputs.s3_policy_result }}"
            echo "  Security Groups: ${{ steps.sg-policy.outputs.sg_policy_result }}"
            echo "  Required Tags: ${{ steps.tags-policy.outputs.tags_policy_result }}"
            echo ""
            echo "Please fix policy violations before merging."
            exit 1
          else
            echo "✅ All policies passed!"
          fi

# ==============================================================================
# TESTING INSTRUCTIONS (For Thesis)
# ==============================================================================

# TEST CASE 1: Missing S3 Encryption
# - Create PR with tests/vulnerable/unencrypted-s3.tf
# - Expected: S3 encryption policy FAILS
# - Screenshot: PR comment showing policy violation
#
# TEST CASE 2: Open Security Group
# - Create PR with tests/vulnerable/open-security-group.tf
# - Expected: Security groups policy FAILS
# - Screenshot: GitHub Actions log showing SSH violation
#
# TEST CASE 3: Missing Required Tags
# - Create PR with tests/vulnerable/missing-tags.tf
# - Expected: Required tags policy FAILS
# - Screenshot: Policy report showing missing tags
#
# TEST CASE 4: Compliant Infrastructure
# - Create PR with tests/compliant/secure-s3.tf
# - Expected: All policies PASS
# - Screenshot: Green checkmarks on PR

# ==============================================================================
# CUSTOMIZATION
# ==============================================================================

# To add more policies:
# 1. Create new .rego file in policies/
# 2. Add new step following pattern above
# 3. Update policy report generation

# To modify required tags:
# - Edit policies/required_tags.rego
# - Update required_tags list

# To change enforcement level:
# - Remove 'exit 1' to make policies advisory only
# - Keep 'exit 1' to enforce policies (recommended)
